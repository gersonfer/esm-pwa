<!DOCTYPE html>
<html lang="pt-BR" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üèÅ ESM Live Viewer</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#10141a" />

<style>
:root {
  --bg: #0f1115;
  --card: #161a20;
  --card-deck: #2e333a;
  --accent: #ffcc00;
  --text: #f6f6f6;
  --muted: #bbb;
  --ok: #2ecc71;
  --alert: #e74c3c;
  --warn: #f1c40f;
}
body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  display:flex;flex-direction:column;height:100vh;overflow:hidden;
}
header {
  display:flex;justify-content:space-between;align-items:center;
  padding:.6rem 1rem;background:#10141a80;font-size:1rem;
}
#track-badge{
  display:none;
  margin-left:.45rem;
  background:var(--accent);
  padding:.05rem .35rem;
  border-radius:.35rem;
  color:#000;
  font-size:.8rem;
}
#timer {
  font-family:monospace;font-weight:bold;
  padding:.25rem .7rem;border-radius:.5rem;font-size:1rem;
  border:3px solid var(--accent);
  color:var(--accent);
}
#main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

/* === DESKTOP GRID === */
#grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  grid-auto-rows: 1fr;
  gap: .8vw;
  padding: .8vw;
  height: 100%;
  box-sizing: border-box;
  overflow-y: auto;
}

.card-desktop{
  background:var(--card);
  border-radius:.8vw;
  padding:1.0vw;
  box-shadow:0 .4vw 1vw rgba(0,0,0,.25);
  border:5px solid transparent;
  display:flex;flex-direction:column;
}
.card-desktop.deck-active{
  background:var(--card-deck) !important;
}
.card-desktop h3{
  margin:0 0 .8rem 0;
  color:var(--accent);
  font-size:1.25rem;
}
.team-stars {
  color:var(--muted);
  font-size:1rem; margin-left:.3rem;
}
.driver-row{margin-bottom:.65rem;}
.driver-name{
  display:flex;justify-content:space-between;
  font-size:1rem;
}
.medals{
  color:var(--muted);
  font-size:.6rem;
  letter-spacing:1px;
  margin-left:.25rem;
}
.progress {
  width:100%;height:.5rem;background:#222b;border-radius:999px;
  overflow:hidden;margin-top:.2rem;
}
.progress-bar{height:100%;transition:width .4s linear;}
.driver-meta{
  color:var(--muted);
  font-size:.85rem;
  display:flex;justify-content:space-between;margin-top:.1rem;
}

/* === MOBILE CAROUSEL === */
#carousel {
  display: flex;
  height: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
.carousel-card {
  flex: 0 0 100%;
  scroll-snap-align: start;
  padding: 5vw;
  box-sizing: border-box;
  background: var(--card);
  border-radius: 12px;
  border: 5px solid transparent;
  display: flex;
  flex-direction: column;
}
@media (orientation: landscape) {
  .carousel-card { flex: 0 0 50%; }
}

#dots {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 10px 0;
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 20;
}

.dot {
  width: 10px;
  height: 10px;
  background: #666;
  border-radius: 50%;
  opacity: 0.65;
  transition: all 0.25s ease;
}

.dot.active {
  background: var(--accent);
  opacity: 1;
  transform: scale(1.3);
}
</style>
</head>
<body>

<header>
  <span>
    üèÅ ESM Live Viewer
    <span id="track-badge"></span>
  </span>
  <span id="timer">--:--:--</span>
</header>

<div id="main"></div>
<div id="dots"></div>

<script>
(function(){
  const $ = q => document.querySelector(q);
  let activeCardIndex = 0;

  function isMobile(){
    return window.matchMedia("(pointer: coarse)").matches || window.innerWidth < 900;
  }

  function formatTime(sec){
    if (typeof sec !== "number") return "--:--:--";
    sec = Math.max(0,sec|0);
    const h = String(Math.floor(sec/3600)).padStart(2,"0");
    const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  function stars(cat){
    const c=(cat||"").toUpperCase();
    if(c==="LIGHT") return "‚òÖ‚òÜ‚òÜ‚òÜ";
    if(c==="AM") return "‚òÖ‚òÖ‚òÜ‚òÜ";
    if(c==="PRO-AM") return "‚òÖ‚òÖ‚òÖ‚òÜ";
    if(c==="PRO") return "‚òÖ‚òÖ‚òÖ‚òÖ";
    return "";
  }

  function medals(skill){
    const s=(skill||"").toLowerCase();
    if(s==="platinum") return "‚óè‚óè‚óè‚óè";
    if(s==="gold")     return "‚óè‚óè‚óè‚óã";
    if(s==="silver")   return "‚óè‚óè‚óã‚óã";
    if(s==="bronze")   return "‚óè‚óã‚óã‚óã";
    return "";
  }

  function updateTrackBadge(name){
    const badge=$("#track-badge");
    if (!name) badge.style.display="none";
    else {
      badge.style.display="inline-block";
      badge.textContent=name;
    }
  }

  function setTimerBorder(status){
    const el = $("#timer");
    const s = String(status || "").toLowerCase();
    if (s==="running") el.style.borderColor="var(--ok)";
    else if (s==="paused") el.style.borderColor="var(--alert)";
    else if (s==="finished") el.style.borderColor="var(--warn)";
    else el.style.borderColor="var(--accent)";
    el.style.borderWidth="3px";
  }

  /* === DESKTOP === */
  function renderDesktop(data){
    const tlist=data.teams||[];
    $("#main").innerHTML=`
      <div id="grid">
        ${tlist.map(t=>{
          const deck=t.deck?"deck-active":"";
          return `
          <div class="card-desktop ${deck}" style="border-color:${t.color||"#888"}">

            <h3>${t.team_name}<span class="team-stars">${stars(t.category)}</span></h3>

            ${(t.drivers||[]).map(d=>{
              const total=d.stint_duration_sec||0;
              const left=d.stint_left_sec||0;
              const done=total-left;
              const pct=Math.max(0,Math.min(100,Math.round(100*(done/Math.max(1,total)))));
              const color = d.check_in ? "var(--ok)" : "var(--alert)";
              const opacity = d.check_in?1:0.7;

              /* <<< COR DO NOME >>> */
              let nameColor="var(--text)";
              if(left < 120) nameColor="var(--alert)";
              else if(left < 300) nameColor="var(--warn)";

              /* <<< BORDA DO PILOTO (CHECK-IN) ‚Äî AMARELA >>> */
              const borderStyle = d.check_in
                ? "border:2px solid var(--warn); border-radius:6px; padding:4px;"
                : "";
              return `
                <div class="driver-row" style="${borderStyle} opacity:${opacity}">
                  <div class="driver-name">
                    <span style="color:${nameColor}">${d.name}<span class="medals">${medals(d.skill)}</span></span>
                    <span>${pct}%</span>
                  </div>
                  <div class="progress">
                    <div class="progress-bar" style="width:${pct}%;background:${color}"></div>
                  </div>
                  <div class="driver-meta">
                    <span>${(done/60).toFixed(1)} / ${(left/60).toFixed(1)} min</span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>`;
        }).join("")}
      </div>`;
  }

  /* === MOBILE COM DOTS === */
  function renderMobile(data){
    const tlist = data.teams || [];
    const main = $("#main");
    const prevScroll = main.querySelector("#carousel")?.scrollLeft || 0;

    main.innerHTML = `
      <div id="carousel">
        ${tlist.map(t=>`
          <div class="carousel-card" style="border-color:${t.color||"#888"}">
            <h3>${t.team_name}<span class="team-stars">${stars(t.category)}</span></h3>

            ${(t.drivers||[]).map(d=>{
              const total=d.stint_duration_sec||0;
              const left=d.stint_left_sec||0;
              const done=total-left;
              const pct=Math.max(0,Math.min(100,Math.round(100*(done/Math.max(1,total)))));
              const color = d.check_in ? "var(--ok)" : "var(--alert)";

              /* <<< COR DO NOME >>> */
              let nameColor="var(--text)";
              if(left < 120) nameColor="var(--alert)";
              else if(left < 300) nameColor="var(--warn)";

              /* <<< BORDA DO PILOTO (CHECK-IN) ‚Äî AMARELA >>> */
              const borderStyle = d.check_in
                ? "border:2px solid var(--warn); border-radius:6px; padding:4px;"
                : "";

              return `
                <div class="driver-row" style="${borderStyle}">
                  <div class="driver-name">
                    <span style="color:${nameColor}">${d.name}<span class="medals">${medals(d.skill)}</span></span>
                    <span>${pct}%</span>
                  </div>
                  <div class="progress">
                    <div class="progress-bar" style="width:${pct}%;background:${color}"></div>
                  </div>
                  <div class="driver-meta">
                    <span>${(done/60).toFixed(1)} / ${(left/60).toFixed(1)} min</span>
                  </div>
                </div>
              `;
            }).join("")}

          </div>
        `).join("")}
      </div>
    `;

    const el = $("#carousel");
    el.scrollLeft = prevScroll;

    const dots = $("#dots");
    dots.innerHTML = tlist.map((_,i)=>`
      <div class="dot ${i===activeCardIndex?'active':''}"></div>
    `).join("");

    el.addEventListener("scroll", ()=>{
      const card = el.querySelector(".carousel-card");
      if(!card) return;
      const cardW = card.offsetWidth||1;
      activeCardIndex = Math.round(el.scrollLeft / cardW);

      document.querySelectorAll(".dot").forEach((d,i)=>{
        d.classList.toggle("active", i===activeCardIndex);
      });
    });

    document.querySelectorAll(".dot").forEach((d,i)=>{
      d.addEventListener("click", ()=>{
        const el = $("#carousel");
        const card = el.querySelector(".carousel-card");
        if (!card) return;
        const cardW = card.offsetWidth;
        activeCardIndex = i;
        el.scrollTo({ left: i * cardW, behavior: "smooth" });
      });
    });
  }

  function render(data){
    $("#timer").textContent=formatTime(data.race_left_sec);
    setTimerBorder(data.race_status);
    updateTrackBadge(data.track_name);

    if (isMobile()) renderMobile(data);
    else renderDesktop(data);

    if (isMobile()) {
      const el = $("#carousel");
      if (el) {
        const card = el.querySelector(".carousel-card");
        if (card) {
          const cardW = card.offsetWidth;
          el.scrollLeft = activeCardIndex * cardW;
        }
      }
    }
  }

  function connect(){
    const ws=new WebSocket(`wss://esm-live.onrender.com/ws`);
    ws.onmessage=ev=>{
      try{
        const data=JSON.parse(ev.data);
        if(data.type!=="hello") render(data);
      }catch(_){}
    };
    ws.onclose=()=>setTimeout(connect,1000);
  }

  render({race_left_sec:0,teams:[]});
  connect();
})();
</script>

<!-- =============================================================== -->
<!-- === SERVICE WORKER ‚Äî UPDATE SILENCIOSO ========================= -->
<!-- =============================================================== -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then(reg => {

    // Se j√° existir um SW em estado "waiting"
    if (reg.waiting) {
      reg.waiting.postMessage({ type: "SKIP_WAITING" });
    }

    // Quando um novo SW √© encontrado
    reg.addEventListener("updatefound", () => {
      const newWorker = reg.installing;
      newWorker.addEventListener("statechange", () => {
        if (
          newWorker.state === "installed" &&
          navigator.serviceWorker.controller
        ) {
          reg.waiting?.postMessage({ type: "SKIP_WAITING" });
        }
      });
    });

    // Quando um novo SW assume o controle ‚Üí recarregar automaticamente
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      window.location.reload();
    });

  });
}
</script>

</body>
</html>