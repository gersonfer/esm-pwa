<!DOCTYPE html>
<html lang="pt-BR" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üèÅ ESM Live Viewer</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#10141a" />

<!-- CSS EXTERNO -->
<link rel="stylesheet" href="styles.css" />
</head>

<body>

<header>
  <span>
    üèÅ ESM Live Viewer
    <span id="track-badge"></span>
  </span>
  <span id="timer">--:--:--</span>
</header>

<div id="main"></div>
<div id="dots"></div>

<script>
(function(){
  const $ = q => document.querySelector(q);
  let activeCardIndex = 0;

  function isMobile(){
    return window.matchMedia("(pointer: coarse)").matches || window.innerWidth < 900;
  }

  function formatTime(sec){
    if (typeof sec !== "number") return "--:--:--";
    sec = Math.max(0, sec|0);
    const h = String(Math.floor(sec/3600)).padStart(2,"0");
    const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  function stars(cat){
    const c=(cat||"").toUpperCase();
    if(c==="LIGHT") return "‚òÖ‚òÜ‚òÜ‚òÜ";
    if(c==="AM") return "‚òÖ‚òÖ‚òÜ‚òÜ";
    if(c==="PRO-AM") return "‚òÖ‚òÖ‚òÖ‚òÜ";
    if(c==="PRO") return "‚òÖ‚òÖ‚òÖ‚òÖ";
    return "";
  }

  function medals(skill){
    const s = (skill||"").toLowerCase();
    if(s==="platinum") return "‚óè‚óè‚óè‚óè";
    if(s==="gold")     return "‚óè‚óè‚óè‚óã";
    if(s==="silver")   return "‚óè‚óè‚óã‚óã";
    if(s==="bronze")   return "‚óè‚óã‚óã‚óã";
    return "";
  }

  function updateTrackBadge(name){
    const badge=$("#track-badge");
    if (!name) badge.style.display="none";
    else {
      badge.style.display="inline-block";
      badge.textContent=name;
    }
  }

  function setTimerBorder(status){
    const el = $("#timer");
    const s = String(status || "").toLowerCase();

    // limpa estilos para evitar heran√ßa de CSS pr√©via
    el.style.border = "";
    el.style.borderRadius = "8px";

    if (s === "running") {
        el.style.border = "3px solid var(--ok)";
    }
    else if (s === "paused") {
        el.style.border = "3px solid var(--warn)";
    }
    else if (s.includes("over") || s.includes("finish")) {
        el.style.border = "3px solid var(--alert)";
    }
    else {
        el.style.border = "3px solid var(--accent)";
    }
  }

  function fmt(sec) {
    if (!sec || sec < 0) sec = 0;
    sec = Math.floor(sec);
    const h = String(Math.floor(sec / 3600)).padStart(2, "0");
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${h}:${m}:${s}`;
  }

  /* ===========================================================
     DESKTOP RENDER
  ============================================================ */
  function renderDesktop(data){
    const teams=data.teams||[];

    $("#main").innerHTML = `
      <div id="grid">
        ${teams.map(team=>{
          return `
            <div class="card-desktop ${team.deck ? "deck-active" : ""}"
                 style="border-color:${team.color||"#888"}">

              <h3>${team.team_name}
                <span class="team-stars">${stars(team.category)}</span>
              </h3>

              ${(team.drivers||[]).map(d=>{
                const total = d.stint_duration_sec||0;
                const left  = d.stint_left_sec||0;
                const done  = total-left;
                const pct   = Math.max(0,Math.min(100,Math.round(100*(done/Math.max(1,total)))));
                const progressColor = d.check_in ? "var(--ok)" : "var(--alert)";
                const opacity = d.check_in ? 1 : 0.7;

                /* === COR DO NOME === */
                let nameColor="var(--text)";
                if(left < 120) nameColor="var(--alert)";
                else if(left < 300) nameColor="var(--warn)";

                /* =====================================================
                   ESTILO DO PILOTO EM CHECK-IN  (CORRIGIDO)
                   - borda original SEMPRE presente
                   - condi√ß√µes especiais <5, <2, <1
                ====================================================== */
                let bg="", border="", nameBlack="", metaBlack="", pctBlack="";

                if (d.check_in) {

                  // Borda padr√£o do sistema
                  border = "border:2px solid var(--warn)";

                  if (left < 60) {        // < 1 min
                    bg     = "background:#ff0000";
                    border = "border:2px solid #000";
                    nameBlack = "color:#000";
                    metaBlack = "color:#000";
                    pctBlack  = "color:#000";
                  }
                  else if (left < 120) {  // < 2 min
                    bg     = "background:#ff0000";
                    border = "border:2px solid #ffcc00";
                    nameBlack = "color:#000";
                    metaBlack = "color:#000";
                    pctBlack  = "color:#000";
                  }
                  else if (left < 300) {  // < 5 min
                    bg     = "background:#ffcc00";
                    border = "border:2px solid #e74c3c";
                    nameBlack = "color:#000";
                    metaBlack = "color:#000";
                    pctBlack  = "color:#000";
                  }
                }

                // Estilo do cont√™iner
                const boxStyle = d.check_in
                  ? `${bg}; ${border}; border-radius:6px; padding:4px;`
                  : `background:transparent;`;

                return `
                  <div class="driver-row" style="${boxStyle} opacity:${opacity}">
                    <div class="driver-name">
                      <span style="${d.check_in ? nameBlack : `color:${nameColor}`}; font-size:1.30rem; font-weight:600;">
                        ${d.name}<span class="medals">${medals(d.skill)}</span>
                      </span>
                      <span style="${pctBlack}">${pct}%</span>
                    </div>

                    <div class="progress">
                      <div class="progress-bar" style="width:${pct}%;background:${progressColor}"></div>
                    </div>

                    <div class="driver-meta">
                      <span style="${metaBlack}; font-size:1.10rem; font-weight:600;">
                        ${fmt(done)} / ${fmt(left)}
                      </span>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  /* ===========================================================
     MOBILE RENDER
  ============================================================ */
  function renderMobile(data){
    const teams=data.teams||[];
    const main=$("#main");
    const prevScroll = main.querySelector("#carousel")?.scrollLeft || 0;

    main.innerHTML = `
      <div id="carousel">
        ${teams.map(team=>`
          <div class="carousel-card" style="border-color:${team.color||"#888"}">

            <h3>${team.team_name}
              <span class="team-stars">${stars(team.category)}</span>
            </h3>

            ${(team.drivers||[]).map(d=>{
              const total=d.stint_duration_sec||0;
              const left=d.stint_left_sec||0;
              const done=total-left;
              const pct=Math.max(0,Math.min(100,Math.round(100*(done/Math.max(1,total)))));
              const progressColor = d.check_in ? "var(--ok)" : "var(--alert)";

              let nameColor="var(--text)";
              if(left < 120) nameColor="var(--alert)";
              else if(left < 300) nameColor="var(--warn)";

              /* === CHECK-IN (MOBILE) ‚Äî mesmo patch === */
              let bg="", border="", font="";

              if (d.check_in) {
                border = "border:2px solid var(--warn)";

                if (left < 60) {
                  bg    = "background:#ff0000";
                  border = "border:2px solid #000";
                  font   = "color:#000";
                }
                else if (left < 120){
                  bg    = "background:#ff0000";
                  border = "border:2px solid #ffcc00";
                  font   = "color:#000";
                }
                else if (left < 300){
                  bg    = "background:#ffcc00";
                  border = "border:2px solid #e74c3c";
                  font   = "color:#000";
                }
              }

              const boxStyle = d.check_in
                ? `${bg}; ${border}; border-radius:6px; padding:4px; ${font};`
                : `background:transparent;`;

              return `
                <div class="driver-row" style="${boxStyle}">
                  <div class="driver-name">
                    <span style="${d.check_in ? nameBlack : `color:${nameColor}`}; font-size:1.30rem; font-weight:600;">
                      ${d.name}<span class="medals">${medals(d.skill)}</span>
                    </span>
                    <span style="${pctBlack}">${pct}%</span>
                  </div>

                  <div class="progress">
                    <div class="progress-bar" style="width:${pct}%;background:${progressColor}"></div>
                  </div>

                  <div class="driver-meta">
                    <span style="${metaBlack}; font-size:1.10rem; font-weight:600;">
                      ${fmt(done)} / ${fmt(left)}
                    </span>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `).join("")}
      </div>
    `;

    const el = $("#carousel");
    el.scrollLeft = prevScroll;

    const dots=$("#dots");
    dots.innerHTML = teams.map((_,i)=>`
      <div class="dot ${i===activeCardIndex?'active':''}"></div>
    `).join("");

    el.addEventListener("scroll", ()=>{
      const card=el.querySelector(".carousel-card");
      if(!card) return;
      const w=card.offsetWidth||1;
      activeCardIndex=Math.round(el.scrollLeft/w);

      document.querySelectorAll(".dot").forEach((d,i)=>{
        d.classList.toggle("active", i===activeCardIndex);
      });
    });
  }

  function render(data){
    console.log("STATUS BRUTO RECEBIDO:", data.race_status);
    $("#timer").textContent=formatTime(data.race_left_sec);
    setTimerBorder(data.race_status);
    updateTrackBadge(data.track_name);

    if (isMobile()) renderMobile(data);
    else renderDesktop(data);

    if (isMobile()) {
      const el=$("#carousel");
      if (el) {
        const card=el.querySelector(".carousel-card");
        if (card) {
          el.scrollLeft = activeCardIndex * card.offsetWidth;
        }
      }
    }
  }

  function connect(){
    const ws=new WebSocket(`wss://esm-live.onrender.com/ws`);
    ws.onmessage=ev=>{
      try{
        const data=JSON.parse(ev.data);
        if(data.type!=="hello") render(data);
      }catch(_){}
    };
    ws.onclose=()=>setTimeout(connect,1000);
  }

  render({race_left_sec:0,teams:[]});
  connect();

})();
</script>

<script>
/* === SERVICE WORKER === */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").then(reg => {

    if (reg.waiting) {
      reg.waiting.postMessage({ type: "SKIP_WAITING" });
    }

    reg.addEventListener("updatefound", () => {
      const newWorker = reg.installing;
      newWorker.addEventListener("statechange", () => {
        if (
          newWorker.state === "installed" &&
          navigator.serviceWorker.controller
        ) {
          reg.waiting?.postMessage({ type: "SKIP_WAITING" });
        }
      });
    });

    navigator.serviceWorker.addEventListener("controllerchange", () => {
      window.location.reload();
    });

  });
}
</script>

</body>
</html>